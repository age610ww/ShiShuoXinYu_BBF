<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>世说新语 · 人物与故事索引</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .card{padding:1rem;border-radius:1rem;border:1px solid #e5e7eb;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn{padding:.45rem .9rem;border:1px solid #e5e7eb;border-radius:.75rem;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn:hover{background:#f8fafc}
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="text-xl font-bold">世说新语 · 人物与故事索引</div>
      <div class="flex items-center gap-2">
        <button id="btnExportJSON" class="btn">导出JSON</button>
        <button id="btnExportCSV" class="btn">导出CSV</button>
        <button id="btnClear" class="btn">清空</button>
      </div>
    </div>

    <div id="notice" class="text-sm text-gray-600">
      本页将从同目录 <code>shishuoxinyu.xlsx</code> 读取人物与故事；备注/自录来自 Google 表格（已配置）。
    </div>

    <div id="listView" class="space-y-3 hidden">
      <div class="flex gap-2 items-center">
        <input id="searchInput" class="w-full px-4 py-2 rounded-2xl border" placeholder="输入人物名搜索，如：陈蕃、徐稚…" />
        <button id="btnOpenForm" class="btn">✏️ 添加/编辑信息</button>
      </div>
      <div class="text-xs text-gray-500">共 <span id="totalPeople">0</span> 人物；当前显示 <span id="visiblePeople">0</span> 条</div>
      <div id="peopleGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <div id="personView" class="space-y-4 hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="btnBack" type="button" class="btn">返回</button>
          <div id="personName" class="text-2xl font-bold"></div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnOpenForm2" class="btn">✏️ 添加/编辑信息</button>
          <button id="btnExportPersonJSON" class="btn">导出此人 JSON</button>
          <button id="btnExportPersonMD" class="btn">导出此人 Markdown</button>
        </div>
      </div>

      <div class="card">
        <div class="font-semibold mb-1">备注（来自 Google 表格）</div>
        <div id="notesDisplay" class="text-gray-800 whitespace-pre-wrap"></div>
      </div>

      <div class="card">
        <div class="font-semibold mb-2">相关故事（自动提取自 Excel）</div>
        <div id="storiesList" class="space-y-3"></div>
      </div>

      <div class="card">
        <div class="font-semibold mb-2">自录故事（来自 Google 表格）</div>
        <div id="customList" class="space-y-3 text-gray-800"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== 你的链接（已填好） =====
    const CONFIG = {
      SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7XeVZ1zske9iW5l_k26i5yfa4Kcb284XQVrT3mS1j3Mr5QgYWVRNHGrlFNoEe2WbcWpbB1z-_Vq-x/pub?output=csv",
      FORM_URL: "https://docs.google.com/forms/d/e/1FAIpQLSdfd00f4PSD7t_3XzVrESJdQOCp8dRaH6NJHVb6U3IWcoVKNA/viewform"
    };

    // ===== 工具 =====
    const SEP = /[,，、；;\s]+/g;
    const splitNames = (s='') => (s||'').split(SEP).map(x=>x.trim()).filter(Boolean);
    const dl = (data, filename, mime='application/json') => { const blob = new Blob([data], {type: mime}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); };

    // 简易 CSV 解析（支持引号、逗号、换行）
    function parseCSV(text){
      const rows=[]; let i=0, cur='', inQ=false, row=[];
      function pushCell(){ row.push(cur); cur=''; }
      function pushRow(){ rows.push(row); row=[]; }
      while(i<text.length){
        const c=text[i];
        if(inQ){
          if(c=='"' && text[i+1]=='"'){ cur+='"'; i+=2; continue; }
          if(c=='"'){ inQ=false; i++; continue; }
          cur+=c; i++; continue;
        }
        if(c=='"'){ inQ=true; i++; continue; }
        if(c==','){ pushCell(); i++; continue; }
        if(c=='\n'){ pushCell(); pushRow(); i++; continue; }
        if(c=='\r'){ i++; continue; }
        cur+=c; i++;
      }
      pushCell(); if(row.length) pushRow();
      return rows;
    }

    // ===== 状态 =====
    let ROWS=[],PEOPLE=new Map(),STORIES=[],COLUMN_MAP=null,SELECTED=null;
    let CLOUD_ROWS=[]; // 仅用于备注/自录

    // ===== 事件 =====
    function openForm(){
      if(!CONFIG.FORM_URL){ alert('还未设置 FORM_URL（Google 表单链接）'); return; }
      window.open(CONFIG.FORM_URL, '_blank');
    }
    document.getElementById('btnOpenForm').onclick=openForm;
    document.getElementById('btnOpenForm2').onclick=openForm;

    // ===== 仅从 CSV 读取备注/自录（不生成人物） =====
    async function loadCloudRows(){
      if(!CONFIG.SHEET_CSV_URL) return [];
      const res = await fetch(CONFIG.SHEET_CSV_URL, { cache: 'no-store' });
      const text = await res.text();
      const table = parseCSV(text);
      if(table.length===0) return [];
      const header = table[0].map(h=>h.trim());
      const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
      const rows = table.slice(1).map(r=>({
        person: (r[idx.person]||'').trim(),
        type: (r[idx.type]||'').trim().toLowerCase(),
        division: (r[idx.division]||'').trim(),
        text: (r[idx.text]||'').trim(),
        author: (r[idx.author]||'').trim(),
        timestamp: (r[idx.timestamp]||'').trim()
      })).filter(x=>x.person);
      return rows;
    }

    function renderCloudFor(person){
      const notes=[], customs=[];
      CLOUD_ROWS.forEach(r=>{
        if((r.person||'')===person){
          if(r.type==='note') notes.push(r.text||'');
          else if(r.type==='custom') customs.push({ division:r.division||'', text:r.text||'', by:r.author||'', at:r.timestamp||'' });
        }
      });
      document.getElementById('notesDisplay').textContent = notes.length? notes.join('\n') : '（暂无备注）';
      const customList = document.getElementById('customList'); customList.innerHTML='';
      customs.forEach(c=>{
        const el=document.createElement('div'); el.className='p-3 rounded-2xl border bg-white shadow-sm';
        el.innerHTML=`<div class="text-sm text-gray-600 mb-1">${c.division||'自录'} · ${c.by||''} · ${c.at||''}</div><div class="whitespace-pre-wrap">${c.text||''}</div>`;
        customList.appendChild(el);
      });
    }

    // ===== Excel 列检测与构建索引 =====
    function detectColumns(headers){
      const lower=headers.map(h=>String(h||'').toLowerCase());
      const find=p=>headers.find((h,i)=>p.some(q=>lower[i].includes(q)));
      return {
        textCol:find(['正文','text','entry'])||headers[2],
        mainCol:find(['主要','main'])||headers[3],
        otherCol:find(['次要','注','other'])||headers[4],
        divisionCol:find(['门类','类','division'])||headers[0],
        idCol:find(['编号','id'])||headers[1]
      };
    }

    function buildIndex(rows){
      if(!rows?.length) return;
      const headers=Object.keys(rows[0]);
      COLUMN_MAP=detectColumns(headers);
      const{ textCol,mainCol,otherCol,divisionCol,idCol}=COLUMN_MAP;
      STORIES=rows.map((r,i)=>({
        id: r[idCol]||i+1,
        division: r[divisionCol]||'',
        text: r[textCol]||'',
        main: splitNames(r[mainCol]),
        others: splitNames(r[otherCol])
      }));
      PEOPLE=new Map();
      for(const s of STORIES){
        const names=[...new Set([...s.main,...s.others])];
        for(const n of names){
          if(!PEOPLE.has(n)) PEOPLE.set(n,{name:n,stories:[]});
          PEOPLE.get(n).stories.push(s);
        }
      }
    }

    // ===== 视图渲染 =====
    const listView=document.getElementById('listView'),personView=document.getElementById('personView'),peopleGrid=document.getElementById('peopleGrid'),totalPeople=document.getElementById('totalPeople'),visiblePeople=document.getElementById('visiblePeople'),searchInput=document.getElementById('searchInput'),personNameEl=document.getElementById('personName'),storiesList=document.getElementById('storiesList'),notesDisplay=document.getElementById('notesDisplay'),customList=document.getElementById('customList');

    function peopleArray(){
      return Array.from(PEOPLE.values()).sort((a,b)=>a.name.localeCompare(b.name,'zh'));
    }

    function renderPeople(){
      const q=searchInput.value.trim();
      const arr=peopleArray();
      totalPeople.textContent=arr.length;
      const filtered=q?arr.filter(p=>p.name.includes(q)):arr.slice(0,1000);
      visiblePeople.textContent=filtered.length;
      peopleGrid.innerHTML='';
      filtered.forEach(p=>{
        const b=document.createElement('button');
        b.className='text-left p-3 rounded-2xl border shadow-sm hover:bg-gray-50';
        b.innerHTML=`<div class='font-semibold'>${p.name}</div><div class='text-xs text-gray-500 mt-1'>出现 ${p.stories.length} 则</div>`;
        b.onclick=()=>showPerson(p.name);
        peopleGrid.appendChild(b);
      });
    }

    async function showPerson(name){
      SELECTED=name; location.hash='#/person/'+encodeURIComponent(name);
      listView.classList.add('hidden'); personView.classList.remove('hidden');
      personNameEl.textContent=name;

      // 故事（Excel）
      storiesList.innerHTML='';
      const p = PEOPLE.get(name);
      if(p && p.stories.length){
        p.stories.forEach(s=>{
          const div=document.createElement('div'); div.className='p-3 rounded-2xl border bg-white shadow-sm';
          div.innerHTML=`<div class='text-sm text-gray-600 mb-1'>${s.division||''} 编号 ${s.id}</div><div class='whitespace-pre-wrap'>${s.text}</div>`;
          storiesList.appendChild(div);
        });
      } else {
        storiesList.innerHTML = '<div class="text-gray-500">（此人暂无 Excel 中的故事）</div>';
      }

      // 备注/自录（CSV）
      try{ CLOUD_ROWS = await loadCloudRows(); }catch(e){ console.warn(e); }
      renderCloudFor(name);
    }

    document.getElementById('btnBack').onclick=()=>{ personView.classList.add('hidden'); listView.classList.remove('hidden'); SELECTED=null; location.hash=''; renderPeople(); };
    searchInput.oninput=renderPeople;

    document.getElementById('btnExportJSON').onclick=async()=>{
      const payload={ people: peopleArray().map(p=>({ name:p.name, stories:p.stories })) };
      dl(JSON.stringify(payload,null,2),'shishuo_export.json');
    };

    document.getElementById('btnExportCSV').onclick=()=>{
      const header='person,id,division,text'; const EOL='\r\n'; const lines=[];
      peopleArray().forEach(p=>p.stories.forEach(s=>{const t=String(s.text||'').replaceAll('"','""'); lines.push([p.name,s.id,s.division,`"${t}"`].join(',')); }));
      const csv=['\ufeff'+header, ...lines].join(EOL); dl(csv,'shishuo_export.csv','text/csv;charset=utf-8');
    };

    document.getElementById('btnExportPersonJSON').onclick=()=>{
      const p = PEOPLE.get(SELECTED); if(!p) return;
      const payload = { name: SELECTED, stories: p.stories };
      dl(JSON.stringify(payload,null,2), SELECTED + '_stories.json');
    };

    document.getElementById('btnExportPersonMD').onclick=()=>{
      const p = PEOPLE.get(SELECTED); if(!p) return;
      let md = '# ' + SELECTED + '\n\n';
      p.stories.forEach(s=>{ md += '## ' + (s.division||'条目') + ' 编号 ' + s.id + '\n' + (s.text||'') + '\n\n'; });
      dl(md, SELECTED + '.md', 'text/markdown');
    };

    document.getElementById('btnClear').onclick=()=>{ ROWS=[]; PEOPLE=new Map(); STORIES=[]; COLUMN_MAP=null; SELECTED=null; listView.classList.add('hidden'); personView.classList.add('hidden'); alert('已清空'); };

    // ===== 只从 Excel 载入（不做 CSV 兜底） =====
    async function tryLoadExcel(){
      try{
        const res=await fetch('./shishuoxinyu.xlsx',{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const buf=await res.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        ROWS=[]; wb.SheetNames.forEach(n=>ROWS.push(...XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:''})));
        buildIndex(ROWS);
        document.getElementById('notice').innerHTML='已加载 <code>shishuoxinyu.xlsx</code>。';
        listView.classList.remove('hidden'); renderPeople();
        const applyHash=()=>{const h=decodeURIComponent(location.hash.slice(1)); const m=h.match(/^\/person\/(.+)$/); if(m) showPerson(m[1]);};
        window.addEventListener('hashchange', applyHash); applyHash();
      }catch(e){
        document.getElementById('notice').innerHTML='未检测到或无法加载 <code>shishuoxinyu.xlsx</code>，请确认与 <code>index.html</code> 同目录、文件名准确（注意大小写），并强制刷新（Ctrl+F5）。错误：'+e.message;
        console.error('Excel 加载失败：', e);
      }
    }
    tryLoadExcel();
  </script>
</body>
</html>
