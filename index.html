<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>世说新语 · 人物与故事索引</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="text-xl font-bold">世说新语 · 人物与故事索引</div>
      <div class="flex items-center gap-2">
        <button id="btnExportJSON" class="px-3 py-1.5 rounded-xl border shadow-sm hover:bg-gray-50">导出JSON</button>
        <button id="btnExportCSV" class="px-3 py-1.5 rounded-xl border shadow-sm hover:bg-gray-50">导出CSV</button>
        <button id="btnClear" class="px-3 py-1.5 rounded-xl border shadow-sm hover:bg-gray-50">清空</button>
      </div>
    </div>

    <div id="notice" class="text-sm text-gray-600">
      页面将自动加载同目录下的 <code>shishuoxinyu.xlsx</code>。
    </div>

    <div id="listView" class="space-y-3 hidden">
      <div class="relative">
        <input id="searchInput" class="w-full px-4 py-2 rounded-2xl border" placeholder="输入人物名搜索，如：陈蕃、徐稚…" />
      </div>
      <div class="text-xs text-gray-500">共 <span id="totalPeople">0</span> 人物；当前显示 <span id="visiblePeople">0</span> 条</div>
      <div id="peopleGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <div id="personView" class="space-y-4 hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="btnBack" type="button" class="p-2 rounded-xl border hover:bg-gray-50">返回</button>
          <div id="personName" class="text-2xl font-bold"></div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnEdit" class="px-3 py-1.5 rounded-xl border shadow-sm hover:bg-gray-50">✏️ 添加/编辑信息</button>
          <button id="btnExportPersonJSON" class="px-3 py-1.5 rounded-xl border shadow-sm hover:bg-gray-50">导出此人 JSON</button>
          <button id="btnExportPersonMD" class="px-3 py-1.5 rounded-xl border shadow-sm hover:bg-gray-50">导出此人 Markdown</button>
        </div>
      </div>

      <div id="notesDisplay" class="text-gray-800 whitespace-pre-wrap bg-white p-4 rounded-xl border shadow-sm"></div>

      <div id="storiesList" class="space-y-3"></div>
    </div>
  </div>

  <!-- 编辑对话框 -->
  <div id="editModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-xl">
      <h2 class="text-lg font-bold mb-4">添加/编辑信息</h2>
      <label class="block mb-1 font-medium">备注：</label>
      <textarea id="editNotes" class="w-full border rounded-xl p-2 mb-3 min-h-[120px]"></textarea>
      <label class="block mb-1 font-medium">自录故事：</label>
      <input id="customDivision" class="w-full border rounded-xl p-2 mb-2" placeholder="分类（可选）" />
      <textarea id="customText" class="w-full border rounded-xl p-2 min-h-[100px] mb-4" placeholder="输入新的故事文本…"></textarea>
      <div class="flex justify-end gap-3">
        <button id="btnCancel" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50">取消</button>
        <button id="btnSave" class="px-3 py-1.5 rounded-xl border bg-blue-50 hover:bg-blue-100">保存</button>
      </div>
    </div>
  </div>

  <script>
    const SEP = /[,，、；;\s]+/g;
    const splitNames = (s='') => (s||'').split(SEP).map(x=>x.trim()).filter(Boolean);
    const dl = (data, filename, mime='application/json') => { const blob = new Blob([data], {type: mime}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); };
    const keyNotes = n=>`shishuo_notes_${n}`;
    const keyCustom = n=>`shishuo_custom_${n}`;
    const saveNotes = (n,v)=>localStorage.setItem(keyNotes(n),v||'');
    const loadNotes = n=>localStorage.getItem(keyNotes(n))||'';
    const saveCustom = (n,a)=>localStorage.setItem(keyCustom(n),JSON.stringify(a||[]));
    const loadCustom = n=>{try{return JSON.parse(localStorage.getItem(keyCustom(n))||'[]');}catch{return[]}};

    let ROWS=[],PEOPLE=new Map(),STORIES=[],COLUMN_MAP=null,SELECTED=null;

    function detectColumns(headers){const lower=headers.map(h=>String(h||'').toLowerCase());const find=p=>headers.find((h,i)=>p.some(q=>lower[i].includes(q)));return{ textCol:find(['正文','text','entry'])||headers[2], mainCol:find(['主要','main'])||headers[3], otherCol:find(['次要','注','other'])||headers[4], divisionCol:find(['门类','类'])||headers[0], idCol:find(['编号','id'])||headers[1] }}

    function buildIndex(rows){if(!rows?.length)return;const headers=Object.keys(rows[0]);COLUMN_MAP=detectColumns(headers);const{ textCol,mainCol,otherCol,divisionCol,idCol}=COLUMN_MAP;STORIES=rows.map((r,i)=>({id:r[idCol]||i+1,division:r[divisionCol]||'',text:r[textCol]||'',main:splitNames(r[mainCol]),others:splitNames(r[otherCol])}));PEOPLE=new Map();for(const s of STORIES){const names=[...new Set([...s.main,...s.others])];for(const n of names){if(!PEOPLE.has(n))PEOPLE.set(n,{name:n,stories:[]});PEOPLE.get(n).stories.push(s);}}}

    const listView=document.getElementById('listView'),personView=document.getElementById('personView'),peopleGrid=document.getElementById('peopleGrid'),totalPeople=document.getElementById('totalPeople'),visiblePeople=document.getElementById('visiblePeople'),searchInput=document.getElementById('searchInput'),personNameEl=document.getElementById('personName'),storiesList=document.getElementById('storiesList'),notesDisplay=document.getElementById('notesDisplay');

    function peopleArray(){return Array.from(PEOPLE.values()).sort((a,b)=>a.name.localeCompare(b.name,'zh'));}

    function renderPeople(){const q=searchInput.value.trim();const arr=peopleArray();totalPeople.textContent=arr.length;const filtered=q?arr.filter(p=>p.name.includes(q)):arr.slice(0,1000);visiblePeople.textContent=filtered.length;peopleGrid.innerHTML='';filtered.forEach(p=>{const b=document.createElement('button');b.className='text-left p-3 rounded-2xl border shadow-sm hover:bg-gray-50';b.innerHTML=`<div class='font-semibold'>${p.name}</div><div class='text-xs text-gray-500 mt-1'>出现 ${p.stories.length} 则</div>`;b.onclick=()=>showPerson(p.name);peopleGrid.appendChild(b);});}

    function showList(){personView.classList.add('hidden');listView.classList.remove('hidden');SELECTED=null;location.hash='';renderPeople();}

    function showPerson(name){SELECTED=name;location.hash='#/person/'+encodeURIComponent(name);listView.classList.add('hidden');personView.classList.remove('hidden');const p=PEOPLE.get(name);personNameEl.textContent=name;notesDisplay.textContent=loadNotes(name)||'（暂无备注）';storiesList.innerHTML='';p.stories.forEach(s=>{const div=document.createElement('div');div.className='p-3 rounded-2xl border bg-white shadow-sm';div.innerHTML=`<div class='text-sm text-gray-600 mb-1'>${s.division||''} 编号 ${s.id}</div><div class='whitespace-pre-wrap'>${s.text}</div>`;storiesList.appendChild(div);});}

    document.getElementById('btnBack').onclick=showList;
    searchInput.oninput=renderPeople;

    document.getElementById('btnExportJSON').onclick=()=>{const payload={people:peopleArray().map(p=>({name:p.name,notes:loadNotes(p.name),stories:p.stories}))};dl(JSON.stringify(payload,null,2),'shishuo_export.json');};
    document.getElementById('btnExportCSV').onclick=()=>{const header='person,id,division,text';const lines=[];peopleArray().forEach(p=>p.stories.forEach(s=>{lines.push([p.name,s.id,s.division,'"'+s.text.replaceAll('"','""')+'"'].join(','));}));dl([header,...lines].join('\n'),'shishuo_export.csv','text/csv');};
    document.getElementById('btnExportPersonJSON').onclick=()=>{const p=PEOPLE.get(SELECTED);if(p)dl(JSON.stringify({name:p.name,notes:loadNotes(p.name),stories:p.stories},null,2),p.name+'_stories.json');};
    document.getElementById('btnExportPersonMD').onclick=()=>{const p=PEOPLE.get(SELECTED);if(!p)return;let md=`# ${p.name}\n\n备注：${loadNotes(p.name)||''}\n\n`;p.stories.forEach(s=>{md+=`## ${s.division||''} 编号 ${s.id}\n${s.text}\n\n`;});dl(md,p.name+'.md','text/markdown');};

    document.getElementById('btnClear').onclick=()=>{ROWS=[];PEOPLE=new Map();STORIES=[];COLUMN_MAP=null;SELECTED=null;listView.classList.add('hidden');personView.classList.add('hidden');alert('已清空');};

    const modal=document.getElementById('editModal');
    document.getElementById('btnEdit').onclick=()=>{document.getElementById('editNotes').value=loadNotes(SELECTED);modal.classList.remove('hidden');modal.classList.add('flex');};
    document.getElementById('btnCancel').onclick=()=>{modal.classList.add('hidden');modal.classList.remove('flex');};
    document.getElementById('btnSave').onclick=()=>{saveNotes(SELECTED,document.getElementById('editNotes').value);const div=document.getElementById('customDivision').value,text=document.getElementById('customText').value;if(text.trim()){const list=loadCustom(SELECTED);list.push({id:'c'+Date.now(),division:div,text});saveCustom(SELECTED,list);}document.getElementById('customDivision').value='';document.getElementById('customText').value='';modal.classList.add('hidden');modal.classList.remove('flex');showPerson(SELECTED);};

    async function tryLoadDefault(){try{const res=await fetch('./shishuoxinyu.xlsx',{cache:'no-store'});if(!res.ok)throw 0;const buf=await res.arrayBuffer();const wb=XLSX.read(buf,{type:'array'});ROWS=[];wb.SheetNames.forEach(n=>ROWS.push(...XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:''})));buildIndex(ROWS);document.getElementById('notice').innerHTML='已加载 <code>shishuoxinyu.xlsx</code>。';listView.classList.remove('hidden');renderPeople();const applyHash=()=>{const h=decodeURIComponent(location.hash.slice(1));const m=h.match(/^\/person\/(.+)$/);if(m)showPerson(m[1]);};window.addEventListener('hashchange',applyHash);applyHash();}catch{document.getElementById('notice').innerHTML='未检测到 <code>shishuoxinyu.xlsx</code>，请放在同目录。';}}
    tryLoadDefault();
  </script>
</body>
</html>
